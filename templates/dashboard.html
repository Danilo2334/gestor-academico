{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="page-surface">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <p class="text-muted mb-1">Resumen general</p>
            <h3 class="mb-0">Dashboard</h3>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card text-bg-primary">
                <div class="card-body">
                    <h6 class="card-title text-uppercase small mb-1">Estudiantes</h6>
                    <p class="card-text fs-3 mb-0">{{ total_estudiantes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-success">
                <div class="card-body">
                    <h6 class="card-title text-uppercase small mb-1">Docentes</h6>
                    <p class="card-text fs-3 mb-0">{{ total_docentes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-warning">
                <div class="card-body">
                    <h6 class="card-title text-uppercase small mb-1">Cursos</h6>
                    <p class="card-text fs-3 mb-0">{{ total_cursos }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-info">
                <div class="card-body">
                    <h6 class="card-title text-uppercase small mb-1">Materias</h6>
                    <p class="card-text fs-3 mb-0">{{ total_materias }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title mb-3">Promedio por curso</h6>
                    <div class="chart-holder">
                        <canvas id="chartPromedioCurso"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title mb-3">Asistencia del mes por estado</h6>
                    <div class="chart-holder">
                        <canvas id="chartAsistencia"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
Chart.defaults.color = "rgba(231, 237, 246, 0.82)";
Chart.defaults.font.family = "Manrope, system-ui, -apple-system, sans-serif";
Chart.defaults.plugins.legend.labels.boxWidth = 14;
Chart.defaults.plugins.legend.labels.color = "rgba(231, 237, 246, 0.8)";

const cursosLabels = [
    {% for item in promedio_por_curso %}
        "{{ item.materia__curso__nombre }}",
    {% endfor %}
];
const cursosData = [
    {% for item in promedio_por_curso %}
        {{ item.promedio|floatformat:2 }},
    {% endfor %}
];

const ctx1 = document.getElementById('chartPromedioCurso').getContext('2d');
new Chart(ctx1, {
    type: 'bar',
    data: {
        labels: cursosLabels,
        datasets: [{
            label: 'Promedio',
            data: cursosData,
            backgroundColor: "rgba(0, 180, 216, 0.7)",
            borderColor: "rgba(93, 228, 255, 0.9)",
            borderWidth: 1.5,
            borderRadius: 8,
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 10,
                grid: { color: "rgba(255,255,255,0.06)" },
                ticks: { color: "rgba(231, 237, 246, 0.7)" }
            },
            x: {
                grid: { display: false },
                ticks: { color: "rgba(231, 237, 246, 0.7)" }
            }
        }
    }
});

const asistenciaLabels = [
    {% for item in asistencia_mes %}
        "{{ item.estado }}",
    {% endfor %}
];
const asistenciaData = [
    {% for item in asistencia_mes %}
        {{ item.total }},
    {% endfor %}
];

const ctx2 = document.getElementById('chartAsistencia').getContext('2d');
const palette = ["#38bdf8", "#22c55e", "#f59e0b", "#ef4444", "#a855f7"];
const colors = asistenciaData.map((_, idx) => palette[idx % palette.length]);
new Chart(ctx2, {
    type: 'pie',
    data: {
        labels: asistenciaLabels,
        datasets: [{
            data: asistenciaData,
            backgroundColor: colors,
            borderColor: "rgba(255,255,255,0.8)",
            borderWidth: 1
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});
</script>
{% endblock %}
